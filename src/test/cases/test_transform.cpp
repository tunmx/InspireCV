#include "../common/common.h"
#include <inspirecv/inspirecv.h>
#include <vector>

TEST_CASE("test_transform", "[transform]") {
    DRAW_SPLIT_LINE;

    SECTION("sample") {
        // expect
        inspirecv::TransformMatrix expect_mat = inspirecv::TransformMatrix::Create(
          1.60735052, 0.11678111, 80.46166577, -0.11678111, 1.60735052, 96.2739837);

        std::vector<inspirecv::Point2f> src = {{146.319, 174.11},
                                               {203.415, 168.968},
                                               {186.25, 209.472},
                                               {158.474, 239.222},
                                               {200.102, 234.733}};
        std::vector<inspirecv::Point2f> dst{{38.2946, 51.6963},
                                            {73.5318, 51.5014},
                                            {56.0252, 71.7366},
                                            {41.5493, 92.3655},
                                            {70.7299, 92.2041}};

        auto transform = inspirecv::SimilarityTransformEstimateUmeyama(src, dst);

        REQUIRE_NEAR_ARRAY(transform.Squeeze(), expect_mat.Squeeze(), 0.001f);
    }

    SECTION("batch") {
        DRAW_SPLIT_LINE;

        std::vector<inspirecv::Point2f> dst{{38.2946, 51.6963},
                                            {73.5318, 51.5014},
                                            {56.0252, 71.7366},
                                            {41.5493, 92.3655},
                                            {70.7299, 92.2041}};

        std::vector<std::vector<inspirecv::Point2f>> srcs = {
          {{564.03699, 655.7688},
           {818.39026, 643.13531},
           {666.12189, 795.7804},
           {595.15594, 929.49872},
           {792.62787, 921.95087}},
          {{93.031433, 111.88971},
           {135.27611, 108.56781},
           {105.50113, 139.45711},
           {100.80177, 158.13519},
           {139.34065, 155.22606}},
          {{515.23279, 446.534},
           {589.98798, 462.29715},
           {563.47754, 512.02942},
           {504.60468, 548.91571},
           {561.66174, 560.263}},
          {{128.70848, 336.29797},
           {205.61809, 327.79697},
           {101.9481, 409.37473},
           {129.74315, 485.70676},
           {185.47687, 479.68848}},
          {{326.83841, 120.17392},
           {364.36664, 112.05941},
           {382.73727, 137.2704},
           {359.61935, 182.40765},
           {385.42242, 175.57372}},
          {{135.59995, 195.49832},
           {174.49438, 142.32352},
           {182.31258, 197.39566},
           {193.18373, 227.44179},
           {225.08939, 184.53009}},
          {{485.56168, 237.82816},
           {585.43677, 254.35399},
           {525.07318, 280.83817},
           {478.38593, 347.73981},
           {554.57812, 361.51224}},
        };

        std::vector<inspirecv::TransformMatrix> transforms = {
          inspirecv::TransformMatrix::Create(6.926242222158028, 0.1276063384974753,
                                             290.0408068036826, -0.1276063384974753,
                                             6.926241507064568, 298.373996853623),
          inspirecv::TransformMatrix::Create(1.23013457663863, 0.1253805676142548, 36.855527091513,
                                             -0.1253805676142548, 1.230134485506034,
                                             53.23213819607647),
          inspirecv::TransformMatrix::Create(2.378756781863447, -0.4873273630198597,
                                             448.7596520120972, 0.4873274069482729,
                                             2.378756781863447, 307.6703245704704),
          inspirecv::TransformMatrix::Create(3.647552342906693, -0.08233608519342403,
                                             -48.13939474919877, 0.08233608519342403,
                                             3.647552342906693, 140.8982164276572),
          inspirecv::TransformMatrix::Create(1.543679911192009, 0.5626849765168728,
                                             236.8528811517218, -0.5626850167434787,
                                             1.543679750285585, 66.03030106084988),
          inspirecv::TransformMatrix::Create(1.00679086725535, 1.409130025805281, 24.41183850764665,
                                             -1.409129936419919, 1.006790777869987,
                                             195.9969882808232),
          inspirecv::TransformMatrix::Create(2.736053080796349, -0.4906705207277172,
                                             407.7961661693387, 0.4906704631589837,
                                             2.736053311071283, 72.23969205643344)};

        REQUIRE(srcs.size() == transforms.size());

        for (size_t i = 0; i < srcs.size(); ++i) {
            const auto &src = srcs[i];
            const auto &expect_mat = transforms[i];
            auto transform = inspirecv::SimilarityTransformEstimateUmeyama(src, dst);
            REQUIRE_NEAR_ARRAY(transform.Squeeze(), expect_mat.Squeeze(), 0.001f);
        }
    }
}